<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Solicitud de Cita - Cl√≠nica Psicol√≥gica</title>
    <style>
            
            a { color: inherit;text-decoration: none;}
            .material-style-select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 12px; font-size: 1rem; background: #fff; transition: border-color 0.3s, box-shadow 0.3s; appearance: none; }
            .material-style-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2); outline: none; }
            :root { --primary-color: #4A90E2; --secondary-color: #2C3E50; --repcolor: #5e4b8b; --background-color: #F8F9FA; --text-color: #333; }
            * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
            body { background-color: var(--background-color); color: var(--text-color); }
            .container { display: flex; gap: 30px; max-width: 1200px; margin: 50px auto; padding: 0 20px; }
            .form-section { flex: 1; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(21, 33, 73, 0.619); }
            h1 { color: var(--secondary-color); margin-bottom: 15px; font-size: 2em; }
            .subtitle { color: #666; margin-bottom: 30px; font-style: italic; }
            .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px; }
            .full-width { grid-column: 1 / -1; }
            label { display: block; margin-bottom: 10px; font-weight: 500; color: var(--secondary-color); }
            input { width: 100%; padding: 12px; border: 1px solid #0084ff; border-radius: 8px; font-size: 1em; transition: all 0.3s ease; }
            input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(1, 255, 221, 0.268); outline:  none; }
            small { display: block; color: #666; font-size: 0.85em; margin-top: 5px; }
            .calendar-section { flex: 1; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
            .calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; }
            .month-navigation { display: flex; gap: 15px; align-items: center; }
            .nav-button { background: var(--primary-color); color: white; width: 40px; height: 40px; border: none; border-radius: 50%; cursor: pointer; font-size: 1.2em; transition: all 0.3s ease; }
            .nav-button:hover { background: var(--secondary-color); transform: scale(1.1); }
            .current-month { font-size: 1.2em; font-weight: 600; color: var(--secondary-color); }
            .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 20px; }
            .calendar-day { text-align: center; padding: 10px; font-weight: 600; color: var(--secondary-color); }
            .calendar-date { padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; background: white; border: 1px solid #eee; }
            .calendar-date:hover { background: var(--primary-color); color: white; transform: translateY(-2px); }
            .calendar-date.selected { background: var(--secondary-color); color: white; border-color: var(--secondary-color); }
            .disabled { background: #f8f8f8; color: #ccc; cursor: not-allowed; }
            /* Estilo para d√≠as CON horarios disponibles de la BD */
            .calendar-date.available { background: linear-gradient(135deg, #e8f4fd 0%, #d4e9fc 100%); border: 2px solid var(--primary-color); color: var(--secondary-color); font-weight: 600; box-shadow: 0 2px 8px rgba(74, 144, 226, 0.15); }
            .calendar-date.available:hover { background: var(--primary-color); color: white; transform: translateY(-3px); box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3); }
            .calendar-date.available.selected { background: var(--secondary-color); border-color: var(--secondary-color); }
            .time-slots { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 20px; align-items: stretch; }
            /* visually improved time-slot */
            .time-slot {
                padding: 14px 12px;
                border-radius: 14px;
                text-align: center;
                cursor: pointer;
                transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 6px;
                background: linear-gradient(180deg, #c5fff3 0%, #c5fff3 100%);
                border: 1px solid rgba(66, 107, 153, 0.545);
                box-shadow: 0 2px 6px rgba(15, 23, 42, 0.433);
                color: var(--secondary-color);
                min-height: 70px;
            }
            .time-slot:hover { transform: translateY(-6px); box-shadow: 0 8px 22px rgba(34, 47, 62, 0.12); }
            .time-slot .slot-date { font-size: 0.78rem; color: #64748b; text-transform: capitalize; }
            .time-slot .slot-time { font-size: 1.05rem; font-weight: 700; color: var(--secondary-color); }
            .time-slot .slot-meta { font-size: 0.75rem; color: #9aa6b2; }
            .time-slot.selected { background: linear-gradient(90deg, #4A90E2 0%, #357ABD 100%); color: white; border: 1px solid rgba(255,255,255,0.18); box-shadow: 0 10px 30px rgba(53,122,189,0.28); transform: translateY(-6px) scale(1.02); }
            @media (max-width: 900px) { .time-slots { grid-template-columns: repeat(2, 1fr); } }
            /* UI for no slots */
            .no-slots-card {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 8px;
                background: linear-gradient(180deg,#fff 0,#fafafa 100%);
                border-radius: 12px;
                padding: 18px;
                border: 1px dashed rgba(100,100,120,0.12);
                color: #556475;
                box-shadow: 0 4px 12px rgba(20,30,50,0.04);
            }
            .no-slots-card h4 { margin: 0; color: #2c3e50; font-size: 1.05rem; }
            .no-slots-card p { margin: 0; color: #6f8496; font-size: 0.9rem; }
            .no-slots-actions { display:flex; gap:8px; margin-top:8px; }
            .no-slots-actions .btn { padding: 8px 12px; background: #4A90E2; color: #fff; border-radius: 10px; border: none; cursor: pointer; }
            .no-slots-actions .btn.alt { background: transparent; color: #4A90E2; border: 1px solid rgba(74,144,226,0.15); }
            .button-group { display: flex; gap: 15px; margin-top: 30px; }
            .main-button { padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; transition: all 0.3s ease; flex: 1; }
            .submit-button { background: var(--primary-color); color: white; }
            .submit-button:hover { background: var(--secondary-color); }
            .cancel-button { background: #bc4538; color: white; }
            .cancel-button:hover{background: #632121e0;}
            @media (max-width: 768px) { .container { flex-direction: column; margin: 20px auto; } .form-grid { grid-template-columns: 1fr; } .calendar-grid { grid-template-columns: repeat(7, 1fr); } .time-slots { grid-template-columns: repeat(2, 1fr); } }
            @keyframes modalEntry { 0% { transform: scale(0.8) translateY(50px); opacity: 0; } 100% { transform: scale(1) translateY(0); opacity: 1; } }
            @keyframes checkmarkAnim { 0% { stroke-dashoffset: 48; } 100% { stroke-dashoffset: 0; } }
            @keyframes circleAnim { 0% { stroke-dashoffset: 157; } 100% { stroke-dashoffset: 0; } }
            .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: none; justify-content: center; align-items: center; z-index: 1000; }
            .modal.show { display: flex; animation: fadeIn 0.3s; }
            .modal-content { background: white; padding: 2.5rem; border-radius: 1.5rem; width: 90%; max-width: 500px; text-align: center; transform-origin: center; animation: modalEntry 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
            .checkmark { width: 80px; height: 80px; margin: 0 auto 1.5rem; }
            .checkmark__circle { stroke: #4a90e2; stroke-width: 2; stroke-dasharray: 157; stroke-dashoffset: 157; animation: circleAnim 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
            .checkmark__check { transform-origin: 50% 50%; stroke: #4a90e2; stroke-width: 2; stroke-dasharray: 48; stroke-dashoffset: 48; animation: checkmarkAnim 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.4s forwards; }
            .modal-title { color: #2c3e50; margin-bottom: 1.2rem; font-size: 1.8rem; }
            .modal-list { text-align: left; margin: 1.5rem 0; padding-left: 1.2rem; }
            .modal-list li { margin: 0.8rem 0; color: #555; line-height: 1.4; }
            .credentials { background: #f8f9fa; padding: 1rem; border-radius: 0.8rem; margin: 1.2rem 0; font-size: 0.9rem; }
            .modal-button { background: #4a90e2; color: white; border: none; padding: 0.8rem 2rem; border-radius: 2rem; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; margin-top: 1rem; }
            .modal-button:hover { background: #357ABD; transform: translateY(-2px); }
            .reprogramar { padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; transition: all 0.3s ease; flex: 1; }
            .reprogramar-btn { background: var(--repcolor); color: white; }
            .reprogramar-btn:hover{ background: #463371;}
            .reprogramar-cita{ display: flex; gap: 15px; margin-top: 30px; }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @media (max-width: 480px) { .modal-content { padding: 1.5rem; border-radius: 1rem; } .modal-title { font-size: 1.4rem; } }
    </style>
</head>
<body>

<div class="container">
    <div class="form-section">
        <h1>Solicitud de Cita</h1>
        <p class="subtitle">Completa tus datos para agendar tu cita</p>

        <form id="appointmentForm">
            <div class="form-grid">
                <div class="full-width">
                    <label>
                        Nombre completo
                        <input required type="text" id="nombre">
                        <small>Ejemplo: Mar√≠a Guadalupe P√©rez Hern√°ndez</small>
                    </label>
                </div>

                <label>
                    Fecha de nacimiento
                    <input required type="date" id="fechaNacimiento">
                </label>

                <label>
                    Correo electr√≥nico
                    <input required type="email" id="email">
                </label>

                <label>
                    Tel√©fono
                    <input pattern="[0-9]{10}" required type="tel" id="telefono">
                    <small>10 d√≠gitos sin espacios</small>
                </label>

                <div class="full-width">
                    <label for="motivo">Motivo de la consulta</label>
                    <select id="motivo" name="motivo" class="material-style-select" required>
                        <option value="" disabled selected>Selecciona una opci√≥n</option>
                        <option value="Diagnostico Psicol√≥gico">Diagnostico Psicol√≥gico</option>
                        <option value="Psicoterapia">Psicoterapia</option>
                        <option value="Terapia infantil">Terapia infantil</option>
                    </select>
                </div>
            </div>

            <div class="button-group">
                <button class="main-button submit-button" type="submit">Agendar Cita</button>
                <button class="main-button cancel-button" type="reset">Limpiar</button>
            </div>
            <br>
            <div class="reprogramar-cita">
                <button class="reprogramar reprogramar-btn" type="button"><a href="reprogramar.html">Reprogramar Cita</a></button>
                
            </div>
        </form>
    </div>

    <div class="calendar-section">
        <div class="calendar-header">
            <button class="nav-button" id="prevMonth" type="button">‚Äπ</button>
            <span class="current-month" id="monthDisplay">Diciembre 2024</span>
            <button class="nav-button" id="nextMonth" type="button">‚Ä∫</button>
        </div>
        
         <div class="calendar-grid" id="calendarGrid">
             <!-- Se llenar√° din√°micamente con JS -->
          </div>

          <p style="margin-top: 20px; font-size: 0.95rem; color: #666;">Selecciona una fecha para ver horarios disponibles</p>
          
          <div class="time-slots" id="timeSlotsContainer">
              <p>Cargando horarios...</p>
          </div>
      </div>
</div>

<div class="modal" id="confirmationModal">
    <div class="modal-content">
        <div class="animation-container">
            <svg class="checkmark" viewBox="0 0 52 52" xmlns="http://www.w3.org/2000/svg">
                <circle class="checkmark__circle" cx="26" cy="26" fill="none" r="25"/>
                <path class="checkmark__check" d="M14.1 27.2l7.1 7.2 16.7-16.8" fill="none"/>
            </svg>
        </div>
        <h2 class="modal-title">¬°Solicitud Exitosa! üéâ</h2>
        <div class="modal-body">
            <p>Hemos agendado tu cita correctamente.</p>
             <ul class="modal-list">
                <li>‚úîÔ∏è Se envi√≥ un correo de confirmaci√≥n a tu direcci√≥n</li>
            </ul>
            <div class="credentials">
                <p>Correo: <span id="temp-email">(tu correo electr√≥nico)</span></p>
            </div>
        </div>
        <button class="modal-button" id="modalClose">Entendido</button>
    </div>
</div>


<script>
    // URL de tu backend Spring Boot
    const API_BASE_URL = 'http://localhost:8081/api';

    // Estado global
    let selectedHorarioId = null;
    let useMock = false;
    let allHorarios = []; // Almacenar todos los horarios
    let currentMonth = new Date(); // Mes actual mostrado en calendario
    let selectedDateForSlots = null; // Fecha seleccionada en el calendario
    let backendConnected = false; // Flag para rastrear si el backend est√° conectado

    // Datos de prueba (para poder ejecutar la UI sin backend)
    function loadMockSlots() {
        // Usar el mes mostrado en el calendario, no la fecha actual
        const baseDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 5); // D√≠a 5 del mes mostrado
        const slots = [];
        
        // Generar 3 horarios para cada uno de los pr√≥ximos 3 d√≠as
        for (let day = 0; day < 3; day++) {
            const dayDate = new Date(baseDate);
            dayDate.setDate(baseDate.getDate() + day); // D√≠as 5, 6, 7 del mes
            dayDate.setHours(9, 0, 0, 0); // Empezar a las 9:00 AM
            
            // 3 horarios por d√≠a (9:00, 10:30, 12:00)
            for (let slot = 0; slot < 3; slot++) {
                slots.push({
                    horarioId: `m${day * 3 + slot + 1}`,
                    fechaHoraInicio: new Date(dayDate.getTime() + slot * 90 * 60000).toISOString(), // 90 minutos entre cada uno
                    duracionMinutos: 50
                });
            }
        }
        
        return slots;
    }

    /**
     * Renderiza el calendario con d√≠as habilitados/deshabilitados seg√∫n horarios disponibles de la BD
     */
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        
        // Encabezados de d√≠as
        const daysOfWeek = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'Sab'];
        daysOfWeek.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day';
            dayHeader.textContent = day;
            grid.appendChild(dayHeader);
        });
        
        // Primer d√≠a del mes
        const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
        const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
        const startingDayOfWeek = firstDay.getDay();
        
        // Espacios vac√≠os antes del primer d√≠a
        for (let i = 0; i < startingDayOfWeek; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'calendar-date disabled';
            grid.appendChild(emptyCell);
        }
        
        // D√≠as del mes
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const dateCell = document.createElement('div');
            dateCell.className = 'calendar-date';
            dateCell.textContent = day;
            
            const cellDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
            const dateStr = cellDate.toISOString().split('T')[0];
            
            // Verificar si hay horarios para este d√≠a
            // El backend env√≠a fechas como ISO strings, ej: "2025-12-05T09:00:00+05:00"
            const hasSchedule = allHorarios.some(h => {
                if (!h.fechaHoraInicio) return false;
                // Extraer la fecha (YYYY-MM-DD) de la cadena ISO
                const horarioDate = h.fechaHoraInicio.split('T')[0];
                return horarioDate === dateStr;
            });
            
            if (!hasSchedule) {
                dateCell.classList.add('disabled');
            }
            
            // Marcar si fue seleccionado
            if (selectedDateForSlots && selectedDateForSlots === dateStr) {
                dateCell.classList.add('selected');
            }
            
            dateCell.addEventListener('click', () => {
                if (!dateCell.classList.contains('disabled')) {
                    selectDateInCalendar(dateStr);
                }
            });
            
            grid.appendChild(dateCell);
        }
        
        // Actualizar encabezado
        const monthName = currentMonth.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
        document.getElementById('monthDisplay').textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
    }

    /**
     * Selecciona una fecha del calendario y filtra horarios
     */
    function selectDateInCalendar(dateStr) {
        selectedDateForSlots = dateStr;
        renderCalendar(); // Re-renderizar para marcar la selecci√≥n
        filterAndRenderSlots(dateStr); // Mostrar horarios de ese d√≠a
    }

    /**
     * Filtra y renderiza solo los horarios de una fecha espec√≠fica
     */
    function filterAndRenderSlots(dateStr) {
        const container = document.getElementById('timeSlotsContainer');
        const slotsForDate = allHorarios.filter(h => {
            if (!h.fechaHoraInicio) return false;
            // Extraer la fecha (YYYY-MM-DD) de la cadena ISO del backend
            const horarioDate = h.fechaHoraInicio.split('T')[0];
            return horarioDate === dateStr;
        });
        
        if (slotsForDate.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center;">No hay horarios para esta fecha.</p>';
            return;
        }
        
        renderTimeSlots(slotsForDate);
    }

    // Extrae el renderizado de horarios para reusar (evita duplicar c√≥digo)
    function renderTimeSlots(horarios) {
        const container = document.getElementById('timeSlotsContainer');
        container.innerHTML = '';
        if (!horarios || horarios.length === 0) {
            container.innerHTML = '<p>No hay horarios disponibles.</p>';
            return;
        }

        horarios.forEach(horario => {
            const slot = document.createElement('div');
            slot.className = 'time-slot';
            slot.setAttribute('role', 'button');
            slot.setAttribute('tabindex', '0');

            const dt = new Date(horario.fechaHoraInicio);
            const dateShort = dt.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
            const timeShort = dt.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: true });
            const duration = horario.duracionMinutos ? `${horario.duracionMinutos} min` : '';

            slot.innerHTML = `
                <div class="slot-date">${dateShort}</div>
                <div class="slot-time">${timeShort}</div>
                <div class="slot-meta">${duration}</div>
            `;

            const selectSlot = () => {
                selectedHorarioId = horario.horarioId;
                document.querySelectorAll('.time-slot').forEach(t => t.classList.remove('selected'));
                slot.classList.add('selected');
                const submitBtn = document.querySelector('.submit-button');
                if (submitBtn) submitBtn.disabled = false;
            };

            slot.addEventListener('click', selectSlot);
            slot.addEventListener('keydown', (ev) => {
                if (ev.key === 'Enter' || ev.key === ' ') {
                    ev.preventDefault();
                    selectSlot();
                }
            });

            container.appendChild(slot);
        });
    }

    // Al cargar la p√°gina, buscar los horarios
    document.addEventListener('DOMContentLoaded', () => {
        cargarHorariosDisponibles();
        
        // Listeners para navegaci√≥n del calendario
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            selectedDateForSlots = null; // Limpiar la selecci√≥n de fecha
            renderCalendar();
            document.getElementById('timeSlotsContainer').innerHTML = '<p style="color: #999; text-align: center;">Selecciona una fecha para ver horarios disponibles.</p>';
        });
        
        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            selectedDateForSlots = null; // Limpiar la selecci√≥n de fecha
            renderCalendar();
            document.getElementById('timeSlotsContainer').innerHTML = '<p style="color: #999; text-align: center;">Selecciona una fecha para ver horarios disponibles.</p>';
        });
    });

    /**
     * Formatea una fecha ISO (ej. 2025-12-01T09:00:00Z) a un formato legible
     */
    function formatarFechaHora(isoString) {
        const date = new Date(isoString);
        const options = {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        };
        return date.toLocaleString('es-ES', options);
    }

    /**
     * 1. Llama al endpoint GET /api/horarios/disponibles
     */
    async function cargarHorariosDisponibles() {
        const container = document.getElementById('timeSlotsContainer');
        const submitBtn = document.querySelector('.submit-button');
        if (submitBtn) submitBtn.disabled = true;

        try {
            console.log(`Conectando al backend en: ${API_BASE_URL}/horarios/disponibles`);
            const response = await fetch(`${API_BASE_URL}/horarios/disponibles`);
            
            if (!response.ok) {
                throw new Error(`Backend respondi√≥ con ${response.status}`);
            }
            const horarios = await response.json();
            console.log('Horarios recibidos del backend:', horarios);
            
            // Guardar todos los horarios globalmente
            allHorarios = Array.isArray(horarios) ? horarios : [];
            backendConnected = true;

            if (!Array.isArray(horarios) || horarios.length === 0) {
                renderTimeSlots([]);
                container.innerHTML = `
                    <div class="no-slots-card" role="status" aria-live="polite">
                        <h4>Sin horarios disponibles</h4>
                        <p>No hay horarios disponibles en la base de datos.</p>
                        <div class="no-slots-actions">
                            <button class="btn" id="refreshSlotsBtn" type="button">Reintentar</button>
                            <button class="btn alt" id="useMockBtn" type="button">Usar datos de prueba</button>
                        </div>
                    </div>
                `;
                document.getElementById('refreshSlotsBtn').addEventListener('click', () => cargarHorariosDisponibles());
                document.getElementById('useMockBtn').addEventListener('click', () => {
                    useMock = true;
                   allHorarios = loadMockSlots();
                   renderCalendar();
                    renderTimeSlots(allHorarios);
                });
            } else {
               // Mostrar todos los horarios inicialmente
                renderTimeSlots(horarios);
            }
            
            // Renderizar el calendario CON LOS HORARIOS CARGADOS (para que no deshabilite incorrectamente los d√≠as)
            renderCalendar();

        } catch (error) {
            console.error('Error al conectar con backend:', error);
            backendConnected = false;
            container.innerHTML = `
                <div class="no-slots-card" role="alert" aria-live="assertive">
                    <h4>Error al cargar horarios</h4>
                    <p>No se pudo conectar con el backend. Aseg√∫rate que el servidor est√° corriendo en <strong>${API_BASE_URL}</strong></p>
                    <p style="font-size: 0.85rem; color: #888; margin-top: 8px;">Error: ${error.message}</p>
                    <div class="no-slots-actions">
                        <button class="btn" id="retryBtn" type="button">Reintentar</button>
                        <button class="btn alt" id="useMockBtn" type="button">Usar datos de prueba</button>
                    </div>
                </div>
            `;
            const retryBtn = document.getElementById('retryBtn');
            if (retryBtn) retryBtn.addEventListener('click', () => cargarHorariosDisponibles());
            const useMockBtn = document.getElementById('useMockBtn');
            if (useMockBtn) useMockBtn.addEventListener('click', () => {
                useMock = true;
               allHorarios = loadMockSlots();
               renderCalendar();
                renderTimeSlots(allHorarios);
            });
        }
    }

    /**
     * 4. Llama al endpoint POST /api/citas al enviar el formulario
     * (URL CORREGIDA)
     */
    document.getElementById('appointmentForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        // Validar que se seleccion√≥ un horario
        if (!selectedHorarioId) {
            alert('Por favor selecciona un horario disponible.');
            return;
        }

        // 1. Recolectar TODOS los datos del formulario
        const requestData = {
            nombre: document.getElementById('nombre').value,
            email: document.getElementById('email').value,
            telefono: document.getElementById('telefono').value,
            fechaNacimiento: document.getElementById('fechaNacimiento').value,
            horarioId: selectedHorarioId,
            motivoConsulta: document.getElementById('motivo').value
        };


        // 2. Enviar la petici√≥n POST
        try {
            // URL CORREGIDA:
            const response = await fetch(`${API_BASE_URL}/citas`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            // Si la respuesta NO fue exitosa (ej. 409, 404, 500)
            if (!response.ok) {
                // Leemos el mensaje de error que envi√≥ el backend
                const errorMessage = await response.text(); 
                // Lanzamos un error con ESE mensaje
                throw new Error(errorMessage || 'El horario ya no est√° disponible o hubo un error.'); 
            }

            const citaAgendada = await response.json();
            console.log('Cita agendada:', citaAgendada);

            // 3. Mostrar el modal de √©xito
            const modal = document.getElementById('confirmationModal');
            document.getElementById('temp-email').textContent = citaAgendada.paciente.email; 
            
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);

            // Reiniciar animaciones del modal
            document.querySelectorAll('.checkmark__circle, .checkmark__check').forEach(el => {
                el.style.animation = 'none';
                void el.offsetWidth; // Trigger reflow
                el.style.animation = null;
            });

        } catch (error) {
            console.error('Error al agendar:', error);
            // Ahora el alert mostrar√° el error real del backend
            alert(`Error al agendar: ${error.message}`); 
        }
    });

    // L√≥gica para cerrar el modal
    document.getElementById('modalClose').addEventListener('click', function () {
        document.getElementById('confirmationModal').classList.remove('show');
        setTimeout(() => {
            document.getElementById('confirmationModal').style.display = 'none';
            // Recargar la p√°gina para ver los horarios actualizados
            window.location.reload(); 
        }, 300);
    });

</script>
</body>
</html>
