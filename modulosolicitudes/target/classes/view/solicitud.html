<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Solicitud de Cita - Cl铆nica Psicol贸gica</title>
    <style>
            .material-style-select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 12px; font-size: 1rem; background: #fff; transition: border-color 0.3s, box-shadow 0.3s; appearance: none; }
            .material-style-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2); outline: none; }
            :root { --primary-color: #4A90E2; --secondary-color: #2C3E50; --background-color: #F8F9FA; --text-color: #333; }
            * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
            body { background-color: var(--background-color); color: var(--text-color); }
            .container { display: flex; gap: 30px; max-width: 1200px; margin: 50px auto; padding: 0 20px; }
            .form-section { flex: 1; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
            h1 { color: var(--secondary-color); margin-bottom: 15px; font-size: 2em; }
            .subtitle { color: #666; margin-bottom: 30px; font-style: italic; }
            .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px; }
            .full-width { grid-column: 1 / -1; }
            label { display: block; margin-bottom: 10px; font-weight: 500; color: var(--secondary-color); }
            input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; transition: all 0.3s ease; }
            input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); outline: none; }
            small { display: block; color: #666; font-size: 0.85em; margin-top: 5px; }
            .calendar-section { flex: 1; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
            .calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; }
            .month-navigation { display: flex; gap: 15px; align-items: center; }
            .nav-button { background: var(--primary-color); color: white; width: 40px; height: 40px; border: none; border-radius: 50%; cursor: pointer; font-size: 1.2em; transition: all 0.3s ease; }
            .nav-button:hover { background: var(--secondary-color); transform: scale(1.1); }
            .current-month { font-size: 1.2em; font-weight: 600; color: var(--secondary-color); }
            .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 20px; }
            .calendar-day { text-align: center; padding: 10px; font-weight: 600; color: var(--secondary-color); }
            .calendar-date { padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; background: white; border: 1px solid #eee; }
            .calendar-date:hover { background: var(--primary-color); color: white; transform: translateY(-2px); }
            .calendar-date.selected { background: var(--secondary-color); color: white; border-color: var(--secondary-color); }
            .disabled { background: #f8f8f8; color: #ccc; cursor: not-allowed; }
            .time-slots { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
            .time-slot { padding: 12px; border: 1px solid #eee; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
            .time-slot:hover { border-color: var(--primary-color); color: var(--primary-color); }
            .time-slot.selected { background: var(--primary-color); color: white; border-color: var(--primary-color); }
            .button-group { display: flex; gap: 15px; margin-top: 30px; }
            .main-button { padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; transition: all 0.3s ease; flex: 1; }
            .submit-button { background: var(--primary-color); color: white; }
            .submit-button:hover { background: var(--secondary-color); }
            .cancel-button { background: #e74c3c; color: white; }
            @media (max-width: 768px) { .container { flex-direction: column; margin: 20px auto; } .form-grid { grid-template-columns: 1fr; } .calendar-grid { grid-template-columns: repeat(7, 1fr); } .time-slots { grid-template-columns: repeat(2, 1fr); } }
            @keyframes modalEntry { 0% { transform: scale(0.8) translateY(50px); opacity: 0; } 100% { transform: scale(1) translateY(0); opacity: 1; } }
            @keyframes checkmarkAnim { 0% { stroke-dashoffset: 48; } 100% { stroke-dashoffset: 0; } }
            @keyframes circleAnim { 0% { stroke-dashoffset: 157; } 100% { stroke-dashoffset: 0; } }
            .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: none; justify-content: center; align-items: center; z-index: 1000; }
            .modal.show { display: flex; animation: fadeIn 0.3s; }
            .modal-content { background: white; padding: 2.5rem; border-radius: 1.5rem; width: 90%; max-width: 500px; text-align: center; transform-origin: center; animation: modalEntry 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
            .checkmark { width: 80px; height: 80px; margin: 0 auto 1.5rem; }
            .checkmark__circle { stroke: #4a90e2; stroke-width: 2; stroke-dasharray: 157; stroke-dashoffset: 157; animation: circleAnim 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
            .checkmark__check { transform-origin: 50% 50%; stroke: #4a90e2; stroke-width: 2; stroke-dasharray: 48; stroke-dashoffset: 48; animation: checkmarkAnim 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.4s forwards; }
            .modal-title { color: #2c3e50; margin-bottom: 1.2rem; font-size: 1.8rem; }
            .modal-list { text-align: left; margin: 1.5rem 0; padding-left: 1.2rem; }
            .modal-list li { margin: 0.8rem 0; color: #555; line-height: 1.4; }
            .credentials { background: #f8f9fa; padding: 1rem; border-radius: 0.8rem; margin: 1.2rem 0; font-size: 0.9rem; }
            .modal-button { background: #4a90e2; color: white; border: none; padding: 0.8rem 2rem; border-radius: 2rem; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; margin-top: 1rem; }
            .modal-button:hover { background: #357ABD; transform: translateY(-2px); }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @media (max-width: 480px) { .modal-content { padding: 1.5rem; border-radius: 1rem; } .modal-title { font-size: 1.4rem; } }
    </style>
</head>
<body>

<div class="container">
    <div class="form-section">
        <h1>Solicitud de Cita</h1>
        <p class="subtitle">Completa tus datos para agendar tu cita</p>

        <form id="appointmentForm">
            <div class="form-grid">
                <div class="full-width">
                    <label>
                        Nombre completo
                        <input required type="text" id="nombre">
                        <small>Ejemplo: Mar铆a Guadalupe P茅rez Hern谩ndez</small>
                    </label>
                </div>

                <label>
                    Fecha de nacimiento
                    <input required type="date" id="fechaNacimiento">
                </label>

                <label>
                    Correo electr贸nico
                    <input required type="email" id="email">
                </label>

                <label>
                    Tel茅fono
                    <input pattern="[0-9]{10}" required type="tel" id="telefono">
                    <small>10 d铆gitos sin espacios</small>
                </label>

                <div class="full-width">
                    <label for="motivo">Motivo de la consulta</label>
                    <select id="motivo" name="motivo" class="material-style-select" required>
                        <option value="" disabled selected>Selecciona una opci贸n</option>
                        <option value="Diagnostico Psicol贸gico">Diagnostico Psicol贸gico</option>
                        <option value="Psicoterapia">Psicoterapia</option>
                        <option value="Terapia infantil">Terapia infantil</option>
                    </select>
                </div>
            </div>

            <div class="button-group">
                <button class="main-button submit-button" type="submit">Agendar Cita</button>
                <button class="main-button cancel-button" type="reset">Limpiar</button>
            </div>
            <br>
            <div>
                <a href="reprogramar.html">Reprogramar Cita</a>
            </div>
        </form>
    </div>

    <div class="calendar-section">
        <div class="calendar-header">
            <span class="current-month">Horarios Disponibles</span>
        </div>
        
        <p>Por favor, selecciona un horario de la lista:</p>
        
        <div class="time-slots" id="timeSlotsContainer">
            <p>Cargando horarios...</p>
        </div>
    </div>
</div>

<div class="modal" id="confirmationModal">
    <div class="modal-content">
        <div class="animation-container">
            <svg class="checkmark" viewBox="0 0 52 52" xmlns="http://www.w3.org/2000/svg">
                <circle class="checkmark__circle" cx="26" cy="26" fill="none" r="25"/>
                <path class="checkmark__check" d="M14.1 27.2l7.1 7.2 16.7-16.8" fill="none"/>
            </svg>
        </div>
        <h2 class="modal-title">隆Solicitud Exitosa! </h2>
        <div class="modal-body">
            <p>Hemos agendado tu cita correctamente.</p>
             <ul class="modal-list">
                <li>锔 Se envi贸 un correo de confirmaci贸n a tu direcci贸n</li>
            </ul>
            <div class="credentials">
                <p>Correo: <span id="temp-email">(tu correo electr贸nico)</span></p>
            </div>
        </div>
        <button class="modal-button" id="modalClose">Entendido</button>
    </div>
</div>


<script>
    // URL de tu backend Spring Boot
    const API_BASE_URL = 'http://localhost:8081/api';

    // Estado global
    let selectedHorarioId = null;

    // Al cargar la p谩gina, buscar los horarios
    document.addEventListener('DOMContentLoaded', () => {
        cargarHorariosDisponibles();
    });

    /**
     * Formatea una fecha ISO (ej. 2025-12-01T09:00:00Z) a un formato legible
     */
    function formatarFechaHora(isoString) {
        const date = new Date(isoString);
        const options = {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        };
        return date.toLocaleString('es-ES', options);
    }

    /**
     * 1. Llama al endpoint GET /api/horarios/disponibles
     * (URL CORREGIDA)
     */
    async function cargarHorariosDisponibles() {
        const container = document.getElementById('timeSlotsContainer');
        try {
            // URL CORREGIDA:
            const response = await fetch(`${API_BASE_URL}/horarios/disponibles`);
            
            if (!response.ok) {
                throw new Error('No se pudieron cargar los horarios.');
            }
            const horarios = await response.json();
            
            container.innerHTML = ''; // Limpiar el "Cargando..."

            if (horarios.length === 0) {
                 container.innerHTML = '<p>No hay horarios disponibles por el momento.</p>';
                 return;
            }

            // 2. Renderiza cada horario como un bot贸n
            horarios.forEach(horario => {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                slot.textContent = formatarFechaHora(horario.fechaHoraInicio);
                
                // 3. Agrega un listener para seleccionar el horario
                slot.addEventListener('click', () => {
                    // Guardar el ID
                    selectedHorarioId = horario.horarioId;
                    
                    // Resaltar visualmente
                    document.querySelectorAll('.time-slot').forEach(t => t.classList.remove('selected'));
                    slot.classList.add('selected');
                });
                
                container.appendChild(slot);
            });

        } catch (error) {
            console.error('Error:', error);
            container.innerHTML = '<p style="color: red;">Error al cargar horarios. Aseg煤rate que el backend est茅 corriendo.</p>';
        }
    }


    /**
     * 4. Llama al endpoint POST /api/citas al enviar el formulario
     * (URL CORREGIDA)
     */
    document.getElementById('appointmentForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        // Validar que se seleccion贸 un horario
        if (!selectedHorarioId) {
            alert('Por favor selecciona un horario disponible.');
            return;
        }

        // 1. Recolectar TODOS los datos del formulario
        const requestData = {
            nombre: document.getElementById('nombre').value,
            email: document.getElementById('email').value,
            telefono: document.getElementById('telefono').value,
            fechaNacimiento: document.getElementById('fechaNacimiento').value,
            horarioId: selectedHorarioId,
            motivoConsulta: document.getElementById('motivo').value
        };


        // 2. Enviar la petici贸n POST
        try {
            // URL CORREGIDA:
            const response = await fetch(`${API_BASE_URL}/citas`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            // Si la respuesta NO fue exitosa (ej. 409, 404, 500)
            if (!response.ok) {
                // Leemos el mensaje de error que envi贸 el backend
                const errorMessage = await response.text(); 
                // Lanzamos un error con ESE mensaje
                throw new Error(errorMessage || 'El horario ya no est谩 disponible o hubo un error.'); 
            }

            const citaAgendada = await response.json();
            console.log('Cita agendada:', citaAgendada);

            // 3. Mostrar el modal de 茅xito
            const modal = document.getElementById('confirmationModal');
            document.getElementById('temp-email').textContent = citaAgendada.paciente.email; 
            
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);

            // Reiniciar animaciones del modal
            document.querySelectorAll('.checkmark__circle, .checkmark__check').forEach(el => {
                el.style.animation = 'none';
                void el.offsetWidth; // Trigger reflow
                el.style.animation = null;
            });

        } catch (error) {
            console.error('Error al agendar:', error);
            // Ahora el alert mostrar谩 el error real del backend
            alert(`Error al agendar: ${error.message}`); 
        }
    });

    // L贸gica para cerrar el modal
    document.getElementById('modalClose').addEventListener('click', function () {
        document.getElementById('confirmationModal').classList.remove('show');
        setTimeout(() => {
            document.getElementById('confirmationModal').style.display = 'none';
            // Recargar la p谩gina para ver los horarios actualizados
            window.location.reload(); 
        }, 300);
    });

</script>
</body>
</html>